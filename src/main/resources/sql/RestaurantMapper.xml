<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bitc.next502.team_prj.mapper.RestaurantMapper">

    <select id="selectTop3Restaurants" resultType="bitc.next502.team_prj.dto.RestaurantDTO">
        SELECT
            r.restaurant_id AS restaurantId,
            COALESCE(rd.title, r.place) AS restaurantName,
            r.category AS category,
            c.foods AS foods,
            r.addr1 AS address,
            r.cntct_tel AS restaurantTel,
            r.main_img AS mainImg,
            r.itemcntnts AS itemCntnts,
            COALESCE(ROUND(AVG(rv.rating),1), 0) AS rating
        FROM restaurant AS r
                 JOIN category c ON r.category = c.category
                 LEFT JOIN restaurant_detail rd ON r.restaurant_id = rd.restaurant_id
                 LEFT JOIN review rv ON r.restaurant_id = rv.restaurant_id
        GROUP BY
            r.restaurant_id,
            rd.title,
            r.place,
            r.category,
            c.foods,
            r.addr1,
            r.cntct_tel,
            r.main_img,
            r.itemcntnts
        ORDER BY rating DESC, COUNT(rv.review_idx) DESC
            LIMIT 3
    </select>

    <select id="selectRestaurantDetail"
            resultType="bitc.next502.team_prj.dto.RestaurantDTO">
        SELECT
            r.restaurant_id AS restaurantId,
            COALESCE(rd.title, r.place) AS restaurantName,
            r.category AS category,
            c.foods AS foods,
            r.addr1 AS address,
            r.cntct_tel AS restaurantTel,
            r.gugun_nm AS locationTag,
            r.max_capacity AS maxCapacity,
            r.itemcntnts AS description,
            r.lat AS lat,
            r.lng AS lng,
            rd.main_img_thumb AS mainImgThumb,
            r.itemcntnts AS itemCntnts,
            COALESCE((
                         SELECT ROUND(AVG(rv.rating),1)
                         FROM review rv
                         WHERE rv.restaurant_id = r.restaurant_id
                     ), 0) AS rating
        FROM restaurant r
                 JOIN category c ON r.category = c.category
                 LEFT JOIN restaurant_detail rd ON r.restaurant_id = rd.restaurant_id
        WHERE r.restaurant_id = #{restaurantId}
            LIMIT 1
    </select>

    <select id="selectReviewsByRestaurantId"
            resultType="bitc.next502.team_prj.dto.ReviewDTO">
        SELECT
        review_idx     AS reviewIdx,
        rating         AS rating,
        user_id        AS userId,
        comment        AS comment,
        create_date    AS createDate,
        reply_content  AS replyContent,
        reply_date     AS replyDate
        FROM review
        WHERE restaurant_id = #{restaurantId}
        ORDER BY create_date DESC
    </select>

    <select id="selectReviewCountByRestaurantId" resultType="int">
        SELECT COUNT(*)
        FROM review
        WHERE restaurant_id = #{restaurantId}
    </select>

    <select id="selectRatingStatsByRestaurantId"
            resultType="bitc.next502.team_prj.dto.RatingStatDTO">
        SELECT
            rating AS rating,
            COUNT(*) AS count
        FROM review
        WHERE restaurant_id = #{restaurantId}
        GROUP BY rating
        ORDER BY rating DESC
    </select>

    <select id="searchByKeyword" resultType="bitc.next502.team_prj.dto.RestaurantDTO">
        SELECT
            r.restaurant_id AS restaurantId,
            COALESCE(rd.title, r.place) AS restaurantName,
            r.category AS category,
            c.foods AS foods,
            r.addr1 AS address,
            r.gugun_nm AS locationTag,
            r.main_img AS mainImg,
            rd.main_img_thumb AS mainImgThumb,
            r.itemcntnts AS description,
            COALESCE(ROUND(AVG(rv.rating), 1), 0) AS rating,
            COUNT(rv.review_idx) AS reviewCount
        FROM restaurant r
                 JOIN category c ON r.category = c.category
                 LEFT JOIN restaurant_detail rd ON r.restaurant_id = rd.restaurant_id
                 LEFT JOIN review rv ON r.restaurant_id = rv.restaurant_id
        WHERE r.place LIKE CONCAT('%', #{keyword}, '%')
           OR c.foods LIKE CONCAT('%', #{keyword}, '%')
           OR r.addr1 LIKE CONCAT('%', #{keyword}, '%')
        GROUP BY
            r.restaurant_id,
            rd.title,
            r.place,
            r.category,
            c.foods,
            r.addr1,
            r.gugun_nm,
            r.main_img,
            rd.main_img_thumb,
            r.itemcntnts
        ORDER BY rating DESC
    </select>

    <select id="searchByFilter" resultType="bitc.next502.team_prj.dto.RestaurantDTO">
        SELECT
        r.restaurant_id AS restaurantId,
        COALESCE(rd.title, r.place) AS restaurantName,
        c.foods AS foods,
        r.category AS category,
        r.addr1 AS address,
        r.gugun_nm AS locationTag,
        r.main_img AS mainImg,
        r.itemcntnts AS description, COALESCE(ROUND(AVG(rv.rating), 1), 0) AS rating,
        COUNT(rv.review_idx) AS reviewCount
        FROM restaurant r
        JOIN category c ON r.category = c.category
        LEFT JOIN restaurant_detail rd ON r.restaurant_id = rd.restaurant_id
        LEFT JOIN review rv ON r.restaurant_id = rv.restaurant_id
        WHERE (
        r.place LIKE CONCAT('%', #{keyword}, '%')
        OR rd.title LIKE CONCAT('%', #{keyword}, '%')
        OR r.itemcntnts LIKE CONCAT('%', #{keyword}, '%') OR c.foods LIKE CONCAT('%', #{keyword}, '%')
        OR r.addr1 LIKE CONCAT('%', #{keyword}, '%')
        OR r.gugun_nm LIKE CONCAT('%', #{keyword}, '%')
        )

        <if test="locations != null and locations.size() > 0">
            AND r.gugun_nm IN
            <foreach item="loc" collection="locations" open="(" separator="," close=")">
                #{loc}
            </foreach>
        </if>

        <if test="categories != null and categories.size() > 0">
            AND c.foods IN
            <foreach item="cat" collection="categories" open="(" separator="," close=")">
                #{cat}
            </foreach>
        </if>

        GROUP BY
        r.restaurant_id,
        rd.title,
        r.place,
        c.foods,
        r.category,
        r.addr1,
        r.gugun_nm,
        r.main_img,
        r.itemcntnts

        <choose>
            <when test="sort == 'reviews'">ORDER BY reviewCount DESC</when>
            <otherwise>ORDER BY rating DESC</otherwise>
        </choose>
    </select>

    <insert id="insertRestaurant" useGeneratedKeys="true" parameterType="bitc.next502.team_prj.dto.RestaurantDTO">
        INSERT INTO restaurant (
            place, category, addr1, main_img, itemcntnts, gugun_nm, max_capacity, price)
        VALUES ( #{restaurantName}, #{category}, #{address}, #{mainImg}, #{description}, #{locationTag}, #{seats}, #{price})
    </insert>

    <!-- 식당 정보 수정 -->
    <update id="updateRestaurant" parameterType="bitc.next502.team_prj.dto.RestaurantDTO">
        UPDATE restaurant
        SET
        place = #{restaurantName},
        category = #{category},
        addr1 = #{address},
        gugun_nm = #{locationTag},
        max_capacity = #{maxCapacity},
        itemcntnts = #{itemCntnts},
        price = #{price}
        <if test="mainImg != null and mainImg != ''">
            , main_img = #{mainImg}
        </if>
        WHERE restaurant_id = #{restaurantId};
    </update>

    <!-- 식당 삭제 -->
    <delete id="deleteRestaurant">
        DELETE FROM restaurant
        WHERE restaurant_id = #{restaurantId};
    </delete>

    <select id="selectRestaurantById" parameterType="long" resultType="bitc.next502.team_prj.dto.RestaurantDTO">
        SELECT r.place AS restaurantName,
               r.category AS category,
               c.category AS foods,
               r.addr1 AS address,
               r.cntct_tel AS restaurantTel,
               r.gugun_nm AS locationTag,
               r.price AS price,
               r.main_img AS mainImg,
               r.itemcntnts AS itemCntnts,
               r.max_capacity AS maxCapacity
        FROM restaurant r
                 JOIN category c ON r.category = c.category
        WHERE restaurant_id = #{restaurantId}
    </select>

    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*) FROM restaurant
    </select>
</mapper>
