<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="~{layout/header :: header}"></div>
    <title>NEXT502 | ë§ˆì´í˜ì´ì§€</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <style>
        :root { --main-gold: #b89255; --main-gold-hover: #9c7b46; }

        .text-gold { color: var(--main-gold) !important; }
        .bg-gold-subtle { background-color: #fcf8f3; color: var(--main-gold); }

        /* ì‚¬ì´ë“œë°” ë©”ë‰´  */
        .list-group-item.active {
            background-color: transparent;
            color: var(--main-gold);
            font-weight: bold;
            border-color: #eee;
            border-left: 3px solid var(--main-gold); /* ì™¼ìª½ ê°•ì¡° ì„  */
        }
        .list-group-item { border-left: 3px solid transparent; transition: all 0.2s; }
        .list-group-item:hover { color: var(--main-gold); background-color: #f9f9f9; }

        /* ë²„íŠ¼ ì»¤ìŠ¤í…€ */
        .btn-outline-gold {
            color: var(--main-gold); border-color: var(--main-gold);
        }
        .btn-outline-gold:hover {
            background-color: var(--main-gold); color: white;
        }

        /* ë³„ì  */
        .stars {
            display: flex;
            justify-content: center;
            gap: 6px;
            font-size: 2rem;
            color: #ddd;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .stars span:hover,
        .stars span.active {
            color: #f2b01e;
        }

        .hint {
            font-size: 12px;
            color: #999;
            margin-bottom: 20px;
        }
        /* í˜ì´ì§€ í‘œì‹œ*/
        .page-link {
            color: var(--main-gold); border-color: var(--main-gold);
            border: none;
        }
        .page-link:hover {
            background-color: var(--main-gold); color: white;
        }
        .active>.page-link {
            background-color: var(--main-gold);
            color:white;
            font-weight: bold;
            border-color: var(--main-gold);
        }
        .page-link.active {
            background-color: transparent;
            color:var(--main-gold);
            font-weight: bold;
            border-color: transparent;
        }


    </style>
    <script>
        $(function (){

            const stars = document.querySelectorAll('.stars .star');
            const ratingInput = document.getElementById('rating');
            let selectedRating = 0;

            stars.forEach(function (star) {
                star.addEventListener('click', function () {
                    selectedRating = star.dataset.value;
                    ratingInput.value = selectedRating;
                    updateStars(selectedRating);
                });
                // ë§ˆìš°ìŠ¤ ì˜¤ë²„
                star.addEventListener('mouseover', () => {
                    updateStars(star.dataset.value);
                });

                // ë§ˆìš°ìŠ¤ ì•„ì›ƒ
                star.addEventListener('mouseout', () => {
                    updateStars(selectedRating);
                });
            });

            //ë³„ì ë³€ê²½
            function updateStars(val00) {
                stars.forEach(function (star) {
                    star.classList.toggle(
                        'active',
                        star.dataset.value <= val00
                    );
                });
            }

            $(".datasetval").on("click", function() {
                const ds = $(this);
                const storeName = ds.attr("data-value1");
                const resvId = ds.attr("data-value2");

                openReviewModal(storeName,resvId);

            });


        });


    </script>
</head>
<body class="d-flex flex-column min-vh-100 bg-light">

<div th:replace="~{layout/navbar :: navbar}"></div>

<main class="container my-5">
    <div class="row g-4">

        <aside class="col-lg-3">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body text-center p-4">
                    <div class="bg-secondary bg-opacity-10 rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                        <i class="bi bi-person-fill fs-1 text-secondary"></i>
                    </div>
                    <h5 class="fw-bold mb-1" th:text="${userInfo.name + 'ë‹˜'}">ì‚¬ìš©ìë‹˜</h5>
                </div>
                <div class="list-group list-group-flush small">
                    <a th:href="@{/mypage/main}" class="list-group-item list-group-item-action py-3 px-4 active">
                        <i class="bi bi-calendar-check me-2"></i> ë‚˜ì˜ ì˜ˆì•½ ë‚´ì—­
                    </a>
                    <a th:href="@{/mypage/mybookmarkList}" class="list-group-item list-group-item-action py-3 px-4 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-heart me-2"></i> ê´€ì‹¬ ì‹ë‹¹</span>
                        <span class="badge bg-secondary bg-opacity-10 text-dark rounded-pill" th:text="${bookmarkList != null ? #lists.size(bookmarkList) : 0}">0</span>
                    </a>
                    <a th:href="@{/review/myreviewList(userId=${session.loginUser.userId})}" class="list-group-item list-group-item-action py-3 px-4">
                        <i class="bi bi-pencil-square me-2"></i> ë‚´ê°€ ì“´ ë¦¬ë·°
                    </a>
                    <a th:href="@{/mypage/mypageList}" class="list-group-item list-group-item-action py-3 px-4">
                        <i class="bi bi-gear me-2"></i> ê°œì¸ì •ë³´ ìˆ˜ì •
                    </a>
                </div>
            </div>
        </aside>

        <section class="col-lg-9">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body p-4 p-md-5">

                    <div class="d-flex justify-content-between align-items-end mb-4 pb-2 border-bottom">
                        <h4 class="fw-bold mb-0">ë‚˜ì˜ ì˜ˆì•½ ë‚´ì—­</h4>
                        <span class="small text-gold fw-bold">ìµœê·¼ 3ê°œì›”</span>
                    </div>

                    <div class="vstack gap-3">
                        <div th:if="${#lists.size(resvList.getList())} > 0">
                            <div th:each="resv : ${resvList.getList()}" class="card border border-light-subtle shadow-sm">
                                <div class="card-body d-md-flex justify-content-between align-items-center">
                                    <div class="d-flex gap-3 align-items-center mb-3 mb-md-0">
                                        <div class="text-center">
                                            <span class="badge bg-gold-subtle border border-warning-subtle py-2 px-3 mb-2" th:text="${resv.status}">ë°©ë¬¸ ì˜ˆì •</span>
                                        </div>
                                        <div>
                                            <h5 class="fw-bold mb-1" th:text="${resv.storeName}">ì¶”ì²œ ì‹ë‹¹ A</h5>
                                            <div class="text-muted small">
                                                <i class="bi bi-calendar3 me-1"></i> [[${resv.resvDate}]] <span class="mx-1">|</span>
                                                <i class="bi bi-clock me-1"></i> [[${resv.resvTime}]] <span class="mx-1">|</span>
                                                <i class="bi bi-people me-1"></i> [[${resv.headCount}]]ëª…
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <button th:unless="${resv.status == 'ë°©ë¬¸ì™„ë£Œ' or resv.status == 'ë…¸ì‡¼' or resv.status == 'ì·¨ì†Œ' }"
                                                class="btn btn-outline-secondary btn-sm px-3"
                                                th:onclick="|if(confirm('ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) location.href='/mypage/delete?resvId=${resv.resvId}'|">
                                            ì˜ˆì•½ ì·¨ì†Œ
                                        </button>

                                        <button th:if="${resv.status == 'ë°©ë¬¸ì™„ë£Œ' and resv.isReviewed == 0}"
                                                class="btn btn-outline-gold btn-sm px-3 datasetval"
                                                th:attrappend="data-value1=${resv.storeName},data-value2=${resv.resvId}">
                                            ë¦¬ë·° ì“°ê¸°
                                        </button>

                                        <button th:if="${resv.status == 'ë°©ë¬¸ì™„ë£Œ' and resv.isReviewed == 1}"
                                                class="btn btn-light btn-sm px-3 text-muted" disabled>
                                            ë¦¬ë·° ì‘ì„± ì™„ë£Œ
                                        </button>

                                        <button th:if="${resv.status == 'ë…¸ì‡¼'}"
                                                class="btn btn-light btn-sm px-3 text-muted" disabled>
                                            ë°©ë¬¸í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤.
                                        </button>

                                        <button th:if="${resv.status == 'ì·¨ì†Œ'}"
                                                class="btn btn-light btn-sm px-3 text-muted" disabled>
                                            ê°€ê²Œì—ì„œ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì˜€ìŠµë‹ˆë‹¤.
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!--      í˜ì´ì§€ì‹œì‘-->
                            <div class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" th:classappend="${resvList.getPrePage() == 0} ? 'disabled'">
                                        <a href="#" th:href="@{main(pageNum=${page})}" class="page-link"> &laquo;</a>
                                    </li>
                                    <li class="page-item" th:each="page : ${#numbers.sequence(resvList.getNavigateFirstPage(), resvList.getNavigateLastPage())}" th:classappend="${page == resvList.getPageNum()} ? 'active'">
                                        <a href="#" th:href="@{main(pageNum=${page})}" th:text="${page}" class="page-link">1</a>
                                    </li>
                                    <li class="page-item" th:classappend="${resvList.getNextPage() == 0} ? 'disabled'">
                                        <a href="#" th:href="@{main(pageNum=${page})}" class="page-link">&raquo;</a>
                                    </li>
                                </ul>
                            </div>
                            <!--      í˜ì´ì§€ë-->

                        </div>
                        <div th:unless="${#lists.size(resvList.getList())} > 0">
                            <div th:if="${#lists.isEmpty(resvList)}" class="text-center py-5 text-muted">ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>


                    </div>

                </div>
            </div>
        </section>
    </div>
</main>
<!------------------------------------------------------------------------------------->

<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 480px;">
        <div class="modal-content rounded-4 shadow-lg border-0">

            <div class="modal-header border-bottom-0 pt-4 px-4">
                <h5 class="modal-title fw-bold fs-5">ë¦¬ë·° ì‘ì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body px-4 pb-4">
                <h4 id="modalStoreName" class="text-center fw-bold mb-4 text-gold" style="font-size: 1.4rem;"></h4>

                <form action="/review/reviewWriteReservation" method="post" enctype="multipart/form-data">
                    <input type="hidden" id="modalResvId" name="reservationId" value="">
                    <input type="hidden" id="rating" name="rating" value="0">
                    <input type="hidden" name="imgUrl" value="">

                    <div class="mb-4 text-center">
                        <p class="text-muted small mb-2">ì‹ì‚¬ëŠ” ë§Œì¡±ìŠ¤ëŸ¬ìš°ì…¨ë‚˜ìš”?</p>
                        <div class="stars">
                            <span class="star" data-value="1">â˜…</span>
                            <span class="star" data-value="2">â˜…</span>
                            <span class="star" data-value="3">â˜…</span>
                            <span class="star" data-value="4">â˜…</span>
                            <span class="star" data-value="5">â˜…</span>
                        </div>
                        <div class="hint">ë³„ì„ í´ë¦­í•˜ì—¬ ì ìˆ˜ë¥¼ ë§¤ê²¨ì£¼ì„¸ìš”.</div>


                    </div>

                    <div class="mb-3">
                        <textarea class="form-control bg-light border-0" name="comment" rows="4"
                                  placeholder="ì†”ì§í•œ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”. (ìµœì†Œ 10ì ì´ìƒ)" required style="resize: none; font-size: 0.9rem;"></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-muted small mb-1">ğŸ“· ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</label>
                        <input class="form-control form-control-sm" type="file" id="files" name="files" accept="image/*">
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-outline-gold py-2 fw-bold"
                                style="background-color: var(--main-gold); color: white;">
                            ë“±ë¡í•˜ê¸°
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openReviewModal(storeName, resvId) {

        const nameElement = document.getElementById('modalStoreName');
        const idElement = document.getElementById('modalResvId'); //ì˜ˆì•½ë²ˆí˜¸

        if(nameElement) nameElement.innerText = storeName;
        if(idElement) idElement.value = resvId;

        let reviewModalElement = document.getElementById('reviewModal');
        let reviewModal = bootstrap.Modal.getInstance(reviewModalElement);

        if (!reviewModal) {
            reviewModal = new bootstrap.Modal(reviewModalElement);
        }

        reviewModal.show();
    }
</script>
<div th:replace="~{layout/footer :: footer}"></div>

</body>
</html>
