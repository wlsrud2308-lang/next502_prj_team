<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <div th:replace="~{layout/header :: header}"></div>
  <title>NEXT502 | [[${restaurant.restaurantName}]]</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
      :root { --main-gold: #b89255; }
      .text-gold { color: var(--main-gold) !important; }

      .detail-hero {
        width: 100%;
        height: 450px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .hero-bg-blur {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url([(${restaurant.mainImgThumb})]) center/cover no-repeat;
        filter: blur(15px) brightness(0.7);
        transform: scale(1.1);
        z-index: 1;
      }
      
      .hero-content {
        position: relative;
        z-index: 2;
        padding: 0 20px;
      }

      .hero-card-img {
        width: 320px;
        height: 220px;
        object-fit: cover;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        border: 3px solid rgba(255,255,255,0.3);
      }


      @media (max-width: 768px) {
        .hero-card-img {
          width: 260px;
          height: 180px;
        }
      }

      /* ì˜ˆì•½ ë°•ìŠ¤ */
      .sticky-booking {
          position: sticky;
          top: 100px;
          z-index: 10;
      }

      /* ì§€ë„ ìŠ¤íƒ€ì¼ */
      .map-box {
          width: 100%;
          height: 250px;
          border-radius: 8px;
          border: 1px solid #dee2e6;
      }

      /* ë²„íŠ¼ ì»¤ìŠ¤í…€ */
      .btn-gold { background-color: var(--main-gold); color: white; border: none; }
      .btn-gold:hover { background-color: #9c7b46; color: white; }
      .btn-bookmark { border: 1px solid #dee2e6; color: #ccc; transition: 0.3s; }
      .btn-bookmark.active { color: #e74c3c; border-color: #e74c3c; background: #fff5f5; }


      .star-meter {
          position: relative;
          display: inline-block;
          font-size: 1.1rem;
          letter-spacing: 2px;
          line-height: 1;
          vertical-align: middle;
      }
      .star-meter .stars-bg { color: #d7d7d7; }
      .star-meter .stars-fill {
          position: absolute;
          left: 0;
          top: 0;
          width: 0%;
          overflow: hidden;
          white-space: nowrap;
          color: var(--main-gold);
      }
      /*ì˜ˆì•½í˜ì´ì§€ ê´€ë ¨ íŒì—… ë””ìì¸ css 0209am ì¶”ê°€*/
      .resv-modal {
        display: none; position: fixed; z-index: 10000; left: 0; top: 0;
        width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px); /* ë°°ê²½ì„ ë” ê³ ê¸‰ìŠ¤ëŸ½ê²Œ íë¦¼ ì²˜ë¦¬ */
      }


      .resv-modal-content {
        background: #fff; width: 400px; position: absolute; left: 50%; top: 50%;
        transform: translate(-50%, -50%); border-radius: 0;
        border: 1px solid #eee;
      }

      .modal-gold-line { height: 3px; background: #C19A6B; width: 100%; }

      .modal-body { padding: 50px 40px; text-align: center; }

      .modal-icon-wrapper { font-size: 32px; color: #C19A6B; margin-bottom: 20px; font-weight: 100; }

      .modal-title {
        font-family: 'Noto Serif KR', serif; font-size: 20px; font-weight: 700;
        letter-spacing: 3px; color: #111; margin-bottom: 15px;
      }

      .modal-text { font-size: 14px; color: #777; line-height: 1.8; margin-bottom: 40px; }
      .modal-text span { color: #C19A6B; font-weight: bold; }


      .modal-button-group { display: flex; align-items: center; justify-content: space-between; gap: 15px; }


      .btn-cancel-minimal {
        background: transparent; color: #999; border: 1px solid #ddd;
        padding: 14px 0; flex: 1; font-size: 12px; letter-spacing: 1px;
        transition: 0.3s;
      }
      .btn-cancel-minimal:hover { color: #111; border-color: #111; }


      .btn-login-premium {
        background: #111; color: #fff; border: 1px solid #111;
        padding: 14px 0; flex: 1.2; font-size: 12px; letter-spacing: 1px;
        font-weight: bold; transition: 0.3s;
      }
      .btn-login-premium:hover { background: #C19A6B; border-color: #C19A6B; }

      .owner-reply{
        margin-top:12px;
        padding:12px 14px;
        background:#f5f5f5;
        border-left:4px solid #cfcfcf;
        border-radius:4px;
      }
      .re-tag{ font-weight:800; margin-right:6px; color:#444; }
  </style>



</head>

<body class="bg-white">

<div th:replace="~{layout/navbar :: navbar}"></div>

<div class="detail-hero shadow-inner">
  <div class="hero-bg-blur"></div>

  <div class="hero-content container">
    <div class="d-flex flex-column flex-md-row align-items-center justify-content-center gap-md-5">

      <div class="hero-card-wrapper mb-4 mb-md-0">
        <img th:src="${restaurant.mainImgThumb}" class="hero-card-img" alt="ëŒ€í‘œì´ë¯¸ì§€">
      </div>

      <div class="text-white text-md-start text-center">
        <span class="badge bg-gold mb-2">[[${restaurant.foods}]]</span>
        <h1 class="display-4 fw-bold mb-2">[[${restaurant.restaurantName}]]</h1>
        <p class="fs-5 opacity-75 mb-0">
          <i class="bi bi-geo-alt-fill me-1"></i> [[${restaurant.locationTag}]]
        </p>
      </div>

    </div>
  </div>
</div>

<main class="container my-5">
  <div class="row g-5">

    <section class="col-lg-8">
      <div class="mb-2 text-gold fw-bold small">
        [[${restaurant.foods}]] â€¢ [[${restaurant.locationTag}]]
      </div>
      <h1 class="display-5 fw-bold mb-4">[[${restaurant.restaurantName}]]</h1>

      <div class="d-flex gap-4 py-3 border-top border-bottom mb-4 text-center">
        <div>
          <span class="text-muted small d-block">í‰ì </span>
          <b class="text-gold fs-5">â˜… [[${restaurant.rating}]]</b>
        </div>
        <div class="border-start ps-4">
          <span class="text-muted small d-block">ë¦¬ë·°</span>
          <b class="fs-5">[[${reviewCount}]]ê°œ</b>
        </div>
        <div class="border-start ps-4">
          <span class="text-muted small d-block">ì¢Œì„ ìˆ˜</span>
          <b class="fs-5">[[${restaurant.maxCapacity} != null ? ${restaurant.maxCapacity} : '0']]ì„</b>
        </div>
      </div>

      <div class="py-3">
        <h5 class="fw-bold mb-3">ì‹ë‹¹ ì†Œê°œ</h5>
        <p class="lh-lg text-secondary" style="white-space: pre-line;">[[${restaurant.itemCntnts}]]</p>
      </div>

      <div class="mt-5 pt-5 border-top">
        <h4 class="fw-bold mb-4">
          ë°©ë¬¸ì ë¦¬ë·° <span class="text-gold fs-6">([[${reviewCount}]])</span>
        </h4>

        <!-- ë¦¬ë·° ìš”ì•½ -->
        <div class="bg-light p-4 rounded-3 d-flex align-items-center gap-4 mb-4">
          <h2 class="display-4 fw-bold text-gold mb-0">[[${restaurant.rating}]]</h2>
          <div>
            <div class="star-meter mb-1">
              <div class="stars-bg">â˜…â˜…â˜…â˜…â˜…</div>
              <div class="stars-fill" th:style="'width:' + (${restaurant.rating} * 20) + '%'">â˜…â˜…â˜…â˜…â˜…</div>
            </div>
            <div class="text-muted small">ìµœê·¼ ê³ ê° ë¦¬ë·°ë¥¼ ë°˜ì˜í•œ í‰ê·  í‰ì ì…ë‹ˆë‹¤.</div>
          </div>
        </div>

        <!-- ë³„ì  ë¶„í¬ ë§‰ëŒ€ ì°¨íŠ¸ -->
        <div class="mb-5">
          <h6 class="fw-bold mb-3">ë³„ì  ë¶„í¬</h6>

          <div class="vstack gap-2 small">
            <div class="d-flex align-items-center gap-2">
              <div style="width: 42px;" class="text-muted">5ì </div>
              <div class="progress flex-grow-1" style="height: 10px;">
                <div class="progress-bar"
                     style="background-color: #b89255;"
                     th:style="'width:' + (${reviewCount} == 0 ? 0 : (${ratingCounts[5]} * 100.0 / ${reviewCount})) + '%'">
                </div>
              </div>
              <div style="width: 44px;" class="text-end text-muted" th:text="${ratingCounts[5]}">0</div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div style="width: 42px;" class="text-muted">4ì </div>
              <div class="progress flex-grow-1" style="height: 10px;">
                <div class="progress-bar"
                     style="background-color: #b89255;"
                     th:style="'width:' + (${reviewCount} == 0 ? 0 : (${ratingCounts[4]} * 100.0 / ${reviewCount})) + '%'">
                </div>
              </div>
              <div style="width: 44px;" class="text-end text-muted" th:text="${ratingCounts[4]}">0</div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div style="width: 42px;" class="text-muted">3ì </div>
              <div class="progress flex-grow-1" style="height: 10px;">
                <div class="progress-bar"
                     style="background-color: #b89255;"
                     th:style="'width:' + (${reviewCount} == 0 ? 0 : (${ratingCounts[3]} * 100.0 / ${reviewCount})) + '%'">
                </div>
              </div>
              <div style="width: 44px;" class="text-end text-muted" th:text="${ratingCounts[3]}">0</div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div style="width: 42px;" class="text-muted">2ì </div>
              <div class="progress flex-grow-1" style="height: 10px;">
                <div class="progress-bar"
                     style="background-color: #b89255;"
                     th:style="'width:' + (${reviewCount} == 0 ? 0 : (${ratingCounts[2]} * 100.0 / ${reviewCount})) + '%'">
                </div>
              </div>
              <div style="width: 44px;" class="text-end text-muted" th:text="${ratingCounts[2]}">0</div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div style="width: 42px;" class="text-muted">1ì </div>
              <div class="progress flex-grow-1" style="height: 10px;">
                <div class="progress-bar"
                     style="background-color: #b89255;"
                     th:style="'width:' + (${reviewCount} == 0 ? 0 : (${ratingCounts[1]} * 100.0 / ${reviewCount})) + '%'">
                </div>
              </div>
              <div style="width: 44px;" class="text-end text-muted" th:text="${ratingCounts[1]}">0</div>
            </div>
          </div>
        </div>

        <!-- ë¦¬ë·° ëª©ë¡ -->
        <div class="vstack gap-4">
          <div class="pb-4 border-bottom" th:each="rv : ${reviewList}">
            <div class="d-flex justify-content-between mb-2">
              <span class="fw-bold" th:text="${rv.userId}">ì‘ì„±ì</span>
              <span class="text-muted small" th:text="${rv.createDate}">ì‘ì„±ì¼</span>
            </div>

            <div class="star-meter mb-2">
              <div class="stars-bg">â˜…â˜…â˜…â˜…â˜…</div>
              <div class="stars-fill" th:style="'width:' + (${rv.rating} * 20) + '%'">â˜…â˜…â˜…â˜…â˜…</div>
            </div>

            <p class="text-secondary small mb-0" th:text="${rv.comment}">ë¦¬ë·° ë‚´ìš©</p>
            <div class="owner-reply"
                 th:if="${rv.replyContent != null and !#strings.isEmpty(rv.replyContent)}">
              <span class="re-tag">[Re]</span>
              <span th:text="${rv.replyContent}" style="white-space: pre-line;"></span>
            </div>
          </div>

          <div class="text-muted small" th:if="${#lists.isEmpty(reviewList)}">
            ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </section>

    <aside class="col-lg-4">
      <div class="sticky-booking">
        <div class="card shadow-sm border-light">
          <div class="card-body p-4">
            <h5 class="fw-bold mb-4">ë°©ë¬¸ ì˜ˆì•½</h5>

            <div class="mb-4">
              <label class="form-label small text-muted"><i class="bi bi-geo-alt me-1"></i> ìœ„ì¹˜</label>
              <p class="small mb-2 fw-medium">[[${restaurant.address}]]</p>
              <div id="map" class="map-box mb-3"></div>
            </div>

            <div class="d-flex gap-2 mb-4">

              <!--      ì˜ˆì•½í•˜ê¸° í˜ì´ì§€ ì—°ê²° ì—¬ê¸°ë¶€í„° 323í–‰ ê¹Œì§€ ì˜ˆì•½í˜ì´ì§€ ê´€ë ¨ 0209 am ìˆ˜ì • -->
              <button type="button" class="btn btn-dark btn-lg flex-grow-1 fw-bold py-3" onclick="checkLoginAndGo()">ì˜ˆì•½í•˜ê¸°</button>

              <button type="button" class="btn btn-bookmark btn-lg px-3"
                      th:classappend="${isBookmarked == 1} ? 'active'"
                      th:data-restaurant-id="${restaurant.restaurantId}"
                      th:data-restaurant-name="${restaurant.restaurantName}"
                      onclick="toggleLike(this)">
                <i class="bi bi-heart-fill"></i>
              </button>
              <input type="hidden" th:value="${restaurant.lat}" id="val-lat">
              <input type="hidden" th:value="${restaurant.lng}" id="val-lng">
              <input type="hidden" th:value="${restaurant.restaurantName}" id="val-restName">

            </div>

            <div class="pt-4 border-top">
              <h6 class="fw-bold mb-3 small"><i class="bi bi-compass me-1"></i> ì£¼ë³€ ê´€ê´‘ ëª…ì†Œ (2km ì´ë‚´)</h6>
<!--              <div id="tourMap" class="map-box" style="height: 180px;"></div>-->
              <div id="tourMapTest" class="map-box" style="height: 180px;"></div>
            </div>
          </div>
        </div>
      </div>
    </aside>
    <!--    íŒì—… ë””ìì¸ -->
    <div id="resvSuccessModal" class="resv-modal">
      <div class="resv-modal-content">
        <div class="modal-gold-line"></div>
        <div class="modal-body">
          <i class="bi bi-check2-circle mb-3 d-block" style="font-size: 40px; color: #C19A6B;"></i>
          <h4 class="fw-bold mb-2">RESERVATION CONFIRMED</h4>
          <p class="text-muted small mb-4">
            ì˜ˆì•½ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
            ì •ì„±ìŠ¤ëŸ¬ìš´ ìš”ë¦¬ë¡œ ë§ì´í•˜ê² ìŠµë‹ˆë‹¤.
          </p>
          <button type="button" class="btn-modal-close" onclick="closeResvModal()">í™•ì¸</button>
        </div>
      </div>
    </div>
    <!--    ë¹„ë¡œê·¸ì¸ íŒì—… ë””ìì¸ -->
    <div id="loginCheckModal" class="resv-modal">
      <div class="resv-modal-content">
        <div class="modal-gold-line"></div>

        <div class="modal-body">
          <div class="modal-icon-wrapper">
            <i class="bi bi-shield-lock"></i>
          </div>

          <h5 class="modal-title">MEMBERSHIP ONLY</h5>
          <p class="modal-text">
            í•´ë‹¹ ì„œë¹„ìŠ¤ëŠ” íšŒì› ì „ìš© ê³µê°„ì…ë‹ˆë‹¤.<br>
            <span>NEXT502</span>ì˜ ë©¤ë²„ê°€ ë˜ì–´ íŠ¹ë³„í•œ í˜œíƒì„ ëˆ„ë¦¬ì„¸ìš”.
          </p>

          <div class="modal-button-group">
            <button type="button" class="btn-cancel-minimal" onclick="closeLoginModal()">ì·¨ì†Œ</button>
            <button type="button" class="btn-login-premium" onclick="location.href='/login'">ë¡œê·¸ì¸ í•˜ê¸°</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</main>

<div th:replace="~{layout/footer :: footer}"></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=xu3exk9j7j"></script>

<script th:inline="javascript">
    const resId = [[${restaurant.restaurantId}]];

    $(document).ready(function() {

        const lat = [[${lat}]];
        const lng = [[${lng}]];
        document.getElementById('map');

        const map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(lat, lng), //ì§€ë„ì˜ ì´ˆê¸° ì¤‘ì‹¬ ì¢Œí‘œ
            zoom: 15, //ì§€ë„ì˜ ì´ˆê¸° ì¤Œ ë ˆë²¨
            minZoom: 12, //ì§€ë„ì˜ ìµœì†Œ ì¤Œ ë ˆë²¨
        });

        function checkLoginAndGo() {
            location.href = "/reservation/write?restaurantId=" + resId;
        }

        const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(lat, lng),
            map: map
        });

        window.checkLoginAndGo = function() {
            location.href = "/reservation/write?restaurantId=" + resId;
        }

        window.closeLoginModal = function() {
            const modal = document.getElementById("loginCheckModal");
            if (modal) modal.style.display = "none";
        }
    });
</script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=<KAKAO_APP_KEY>&libraries=services"></script>
<script th:inline="javascript">
    window.onload = function() {

        // // restaurant.lat/lngê°€ ë¬¸ìì—´ì´ì–´ë„ ìˆ«ìë¡œ ë³€í™˜í•´ì„œ ì•ˆì „í•˜ê²Œ ì‚¬ìš©
        // const latRaw = /*[[${restaurant.lat}]]*/ "35.1796";
        // const lngRaw = /*[[${restaurant.lng}]]*/ "129.0756";
        // const lat = parseFloat(latRaw) || 35.1796;
        // const lng = parseFloat(lngRaw) || 129.0756;
        //
        // // 1. ë©”ì¸ ì§€ë„ ì„¤ì •
        // const mapContainer = document.getElementById('map');
        // const mapOption = { center: new kakao.maps.LatLng(lat, lng), level: 3 };
        // const map = new kakao.maps.Map(mapContainer, mapOption);
        //
        // new kakao.maps.Marker({
        //     position: new kakao.maps.LatLng(lat, lng),
        //     map: map
        // });
        //
        // // 2. ê´€ê´‘ì§€ ì§€ë„ ì„¤ì •
        // const tourMapContainer = document.getElementById('tourMap');
        // const tourMapOption = { center: new kakao.maps.LatLng(lat, lng), level: 5 };
        // const tourMap = new kakao.maps.Map(tourMapContainer, tourMapOption);
        //
        // const ps = new kakao.maps.services.Places();
        // ps.categorySearch('AT4', (data, status) => {
        //     if (status === kakao.maps.services.Status.OK) {
        //         data.forEach(place => {
        //             new kakao.maps.Marker({
        //                 position: new kakao.maps.LatLng(place.y, place.x),
        //                 map: tourMap
        //             });
        //         });
        //     }
        // }, { location: new kakao.maps.LatLng(lat, lng), radius: 2000 });

    };

    // ë¹„ë¡œê·¸ì¸ ìƒí™©ì—ì„œ ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ëˆŒë €ì„ë•Œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë³´ë‚´ì£¼ëŠ” ìŠ¤í¬ë¦½íŠ¸ 0209 am  ìˆ˜ì •

    function checkLoginAndGo() {

      const resId = [[${restaurant.restaurantId}]];


      location.href = "/reservation/write?restaurantId=" + resId;
    }

    function closeLoginModal() {


      const modal = document.getElementById("loginCheckModal");
      if(modal) {
        modal.style.display = "none";
      }
    }


    // ************ ì°œí•˜ê¸°(í•˜íŠ¸) ê¸°ëŠ¥**********
    function toggleLike(btn) {
      const restaurantId = $(btn).data("restaurant-id");
      const restaurantName = $(btn).data("restaurant-name");

      const $btn = $(btn);

      $.ajax({
        url: "/bookmark/toggle",
        type: "POST",
        data: {
          restaurantId: restaurantId,
          restaurantName: restaurantName
        },
        success: function(result) {
          if (result === "login-required") {
            // ë¡œê·¸ì¸ ëª¨ë‹¬ ë„ìš°ê¸°
            const modal = document.getElementById("loginCheckModal");
            if(modal) modal.style.display = "block";

          } else if (result === "1") {

            $btn.addClass("active");
            alert("ê´€ì‹¬ ì‹ë‹¹ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ");

          } else if (result === "0") {

            $btn.removeClass("active");
            alert("ê´€ì‹¬ ì‹ë‹¹ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          }
        },
        error: function() {
          alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });
    }

</script>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

  const restaurant = {
    name: $("#val-restName").val(),
    lat: $("#val-lat").val(),
    lng: $("#val-lng").val()
  };

  // ì§€ë„ ìƒì„±
  const map = L.map('tourMapTest').setView([restaurant.lat, restaurant.lng],15);

  // OSM íƒ€ì¼
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  // ì‹ë‹¹ ë§ˆì»¤
  L.marker([restaurant.lat, restaurant.lng])
          .addTo(map)
          .bindPopup(`ğŸ½ï¸ ${restaurant.name} `)
          .openPopup();

  // ë°˜ê²½ (ë¯¸í„°)
  const radius = 2000;

  // Overpass API ì¿¼ë¦¬ (ê´€ê´‘ì§€)
  const query = `
        [out:json];
        (
          node["tourism"](around:${radius},${restaurant.lat},${restaurant.lng});
          way["tourism"](around:${radius},${restaurant.lat},${restaurant.lng});
        );
        out center tags;
    `;

  fetch("https://overpass-api.de/api/interpreter", {
    method: "POST",
    body: query
  })
          .then(res => res.json())
          .then(data => {
            data.elements.forEach(place => {
              const lat = place.lat || place.center.lat;
              const lng = place.lon || place.center.lon;
              const type = place.tags?.type;
              const name = place.tags?.name || "";

              //const osmType = place.type; // node / way / relation
              const osmType = type;
              const osmId = place.id;

              //const detailUrl = `https://www.openstreetmap.org/${type}/${osmId}`
              const marker=L.marker([lat, lng], {
                icon: L.icon({
                  iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
                  iconSize: [25, 25]
                })
              })
                      .addTo(map)
                      .bindTooltip(`ğŸ“${name}`, {
                        direction: 'top',
                        offset: [0, -10],
                        opacity: 0.9
                      });
              marker.on("click",function (){
                const url="https://search.naver.com/search.naver?query="+ name;
                window.open(url,"new");

              });
            });
          });

</script>
</body>
</html>
