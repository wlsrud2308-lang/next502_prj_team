<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <div th:replace="~{layout/header :: header}"></div>
  <title>NEXT502 | [[${restaurant.restaurantName}]]</title>

  <style>
      :root { --main-gold: #b89255; }
      .text-gold { color: var(--main-gold) !important; }

      .detail-hero {
        width: 100%;
        height: 450px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .hero-bg-blur {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url([(${restaurant.mainImgThumb})]) center/cover no-repeat;
        filter: blur(15px) brightness(0.7);
        transform: scale(1.1);
        z-index: 1;
      }
      
      .hero-content {
        position: relative;
        z-index: 2;
        padding: 0 20px;
      }

      .hero-card-img {
        width: 320px;
        height: 220px;
        object-fit: cover;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        border: 3px solid rgba(255,255,255,0.3);
      }


      @media (max-width: 768px) {
        .hero-card-img {
          width: 260px;
          height: 180px;
        }
      }

      /* 예약 박스 */
      .sticky-booking {
          position: sticky;
          top: 100px;
          z-index: 10;
      }

      /* 지도 스타일 */
      .map-box {
          width: 100%;
          height: 250px;
          border-radius: 8px;
          border: 1px solid #dee2e6;
      }

      /* 버튼 커스텀 */
      .btn-gold { background-color: var(--main-gold); color: white; border: none; }
      .btn-gold:hover { background-color: #9c7b46; color: white; }
      .btn-bookmark { border: 1px solid #dee2e6; color: #ccc; transition: 0.3s; }
      .btn-bookmark.active { color: #e74c3c; border-color: #e74c3c; background: #fff5f5; }


      .star-meter {
          position: relative;
          display: inline-block;
          font-size: 1.1rem;
          letter-spacing: 2px;
          line-height: 1;
          vertical-align: middle;
      }
      .star-meter .stars-bg { color: #d7d7d7; }
      .star-meter .stars-fill {
          position: absolute;
          left: 0;
          top: 0;
          width: 0%;
          overflow: hidden;
          white-space: nowrap;
          color: var(--main-gold);
      }
      /*예약페이지 관련 팝업 디자인 css 0209am 추가*/
      .resv-modal {
        display: none; position: fixed; z-index: 10000; left: 0; top: 0;
        width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px); /* 배경을 더 고급스럽게 흐림 처리 */
      }


      .resv-modal-content {
        background: #fff; width: 400px; position: absolute; left: 50%; top: 50%;
        transform: translate(-50%, -50%); border-radius: 0;
        border: 1px solid #eee;
      }

      .modal-gold-line { height: 3px; background: #C19A6B; width: 100%; }

      .modal-body { padding: 50px 40px; text-align: center; }

      .modal-icon-wrapper { font-size: 32px; color: #C19A6B; margin-bottom: 20px; font-weight: 100; }

      .modal-title {
        font-family: 'Noto Serif KR', serif; font-size: 20px; font-weight: 700;
        letter-spacing: 3px; color: #111; margin-bottom: 15px;
      }

      .modal-text { font-size: 14px; color: #777; line-height: 1.8; margin-bottom: 40px; }
      .modal-text span { color: #C19A6B; font-weight: bold; }


      .modal-button-group { display: flex; align-items: center; justify-content: space-between; gap: 15px; }


      .btn-cancel-minimal {
        background: transparent; color: #999; border: 1px solid #ddd;
        padding: 14px 0; flex: 1; font-size: 12px; letter-spacing: 1px;
        transition: 0.3s;
      }
      .btn-cancel-minimal:hover { color: #111; border-color: #111; }


      .btn-login-premium {
        background: #111; color: #fff; border: 1px solid #111;
        padding: 14px 0; flex: 1.2; font-size: 12px; letter-spacing: 1px;
        font-weight: bold; transition: 0.3s;
      }
      .btn-login-premium:hover { background: #C19A6B; border-color: #C19A6B; }
  </style>
</head>

<body class="bg-white">

<div th:replace="~{layout/navbar :: navbar}"></div>

<div class="detail-hero shadow-inner">
  <div class="hero-bg-blur"></div>

  <div class="hero-content container">
    <div class="d-flex flex-column flex-md-row align-items-center justify-content-center gap-md-5">

      <div class="hero-card-wrapper mb-4 mb-md-0">
        <img th:src="${restaurant.mainImgThumb}" class="hero-card-img" alt="대표이미지">
      </div>

      <div class="text-white text-md-start text-center">
        <span class="badge bg-gold mb-2">[[${restaurant.foods}]]</span>
        <h1 class="display-4 fw-bold mb-2">[[${restaurant.restaurantName}]]</h1>
        <p class="fs-5 opacity-75 mb-0">
          <i class="bi bi-geo-alt-fill me-1"></i> [[${restaurant.locationTag}]]
        </p>
      </div>

    </div>
  </div>
</div>

<main class="container my-5">
  <div class="row g-5">

    <section class="col-lg-8">
      <div class="mb-2 text-gold fw-bold small">
        [[${restaurant.foods}]] • [[${restaurant.locationTag}]]
      </div>
      <h1 class="display-5 fw-bold mb-4">[[${restaurant.restaurantName}]]</h1>

      <div class="d-flex gap-4 py-3 border-top border-bottom mb-4 text-center">
        <div>
          <span class="text-muted small d-block">평점</span>
          <b class="text-gold fs-5">★ [[${restaurant.rating}]]</b>
        </div>
        <div class="border-start ps-4">
          <span class="text-muted small d-block">리뷰</span>
          <b class="fs-5">[[${reviewCount}]]개</b>
        </div>
        <div class="border-start ps-4">
          <span class="text-muted small d-block">좌석 수</span>
          <b class="fs-5">[[${restaurant.seats}]]석</b>
        </div>
      </div>

      <div class="py-3">
        <h5 class="fw-bold mb-3">식당 소개</h5>
        <p class="lh-lg text-secondary" style="white-space: pre-line;">[[${restaurant.itemCntnts}]]</p>
      </div>

      <div class="mt-5 pt-5 border-top">
        <h4 class="fw-bold mb-4">
          방문자 리뷰 <span class="text-gold fs-6">([[${reviewCount}]])</span>
        </h4>

        <!-- 리뷰 요약 -->
        <div class="bg-light p-4 rounded-3 d-flex align-items-center gap-4 mb-4">
          <h2 class="display-4 fw-bold text-gold mb-0">[[${restaurant.rating}]]</h2>
          <div>
            <div class="star-meter mb-1">
              <div class="stars-bg">★★★★★</div>
              <div class="stars-fill" th:style="'width:' + (${restaurant.rating} * 20) + '%'">★★★★★</div>
            </div>
            <div class="text-muted small">최근 고객 리뷰를 반영한 평균 평점입니다.</div>
          </div>
        </div>

        <!-- 별점 분포 막대 차트 -->
        <div class="mb-5">
          <h6 class="fw-bold mb-3">별점 분포</h6>

          <div class="vstack gap-2 small">
            <div class="d-flex align-items-center gap-2">
              <div style="width: 42px;" class="text-muted">5점</div>
              <div class="progress flex-grow-1" style="height: 10px;">
                <div class="progress-bar"
                     style="background-color: #b89255;"
                     th:style="'width:' + (${reviewCount} == 0 ? 0 : (${ratingCounts[5]} * 100.0 / ${reviewCount})) + '%'">
                </div>
              </div>
              <div style="width: 44px;" class="text-end text-muted" th:text="${ratingCounts[5]}">0</div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div style="width: 42px;" class="text-muted">4점</div>
              <div class="progress flex-grow-1" style="height: 10px;">
                <div class="progress-bar"
                     style="background-color: #b89255;"
                     th:style="'width:' + (${reviewCount} == 0 ? 0 : (${ratingCounts[4]} * 100.0 / ${reviewCount})) + '%'">
                </div>
              </div>
              <div style="width: 44px;" class="text-end text-muted" th:text="${ratingCounts[4]}">0</div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div style="width: 42px;" class="text-muted">3점</div>
              <div class="progress flex-grow-1" style="height: 10px;">
                <div class="progress-bar"
                     style="background-color: #b89255;"
                     th:style="'width:' + (${reviewCount} == 0 ? 0 : (${ratingCounts[3]} * 100.0 / ${reviewCount})) + '%'">
                </div>
              </div>
              <div style="width: 44px;" class="text-end text-muted" th:text="${ratingCounts[3]}">0</div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div style="width: 42px;" class="text-muted">2점</div>
              <div class="progress flex-grow-1" style="height: 10px;">
                <div class="progress-bar"
                     style="background-color: #b89255;"
                     th:style="'width:' + (${reviewCount} == 0 ? 0 : (${ratingCounts[2]} * 100.0 / ${reviewCount})) + '%'">
                </div>
              </div>
              <div style="width: 44px;" class="text-end text-muted" th:text="${ratingCounts[2]}">0</div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div style="width: 42px;" class="text-muted">1점</div>
              <div class="progress flex-grow-1" style="height: 10px;">
                <div class="progress-bar"
                     style="background-color: #b89255;"
                     th:style="'width:' + (${reviewCount} == 0 ? 0 : (${ratingCounts[1]} * 100.0 / ${reviewCount})) + '%'">
                </div>
              </div>
              <div style="width: 44px;" class="text-end text-muted" th:text="${ratingCounts[1]}">0</div>
            </div>
          </div>
        </div>

        <!-- 리뷰 목록 -->
        <div class="vstack gap-4">
          <div class="pb-4 border-bottom" th:each="rv : ${reviewList}">
            <div class="d-flex justify-content-between mb-2">
              <span class="fw-bold" th:text="${rv.userId}">작성자</span>
              <span class="text-muted small" th:text="${rv.createDate}">작성일</span>
            </div>

            <div class="star-meter mb-2">
              <div class="stars-bg">★★★★★</div>
              <div class="stars-fill" th:style="'width:' + (${rv.rating} * 20) + '%'">★★★★★</div>
            </div>

            <p class="text-secondary small mb-0" th:text="${rv.comment}">리뷰 내용</p>
          </div>

          <div class="text-muted small" th:if="${#lists.isEmpty(reviewList)}">
            아직 등록된 리뷰가 없습니다.
          </div>
        </div>
      </div>
    </section>

    <aside class="col-lg-4">
      <div class="sticky-booking">
        <div class="card shadow-sm border-light">
          <div class="card-body p-4">
            <h5 class="fw-bold mb-4">방문 예약</h5>

            <div class="mb-4">
              <label class="form-label small text-muted"><i class="bi bi-geo-alt me-1"></i> 위치</label>
              <p class="small mb-2 fw-medium">[[${restaurant.address}]]</p>
              <div id="map" class="map-box mb-3"></div>
            </div>

            <div class="d-flex gap-2 mb-4">

              <!--      예약하기 페이지 연결 여기부터 323행 까지 예약페이지 관련 0209 am 수정 -->
              <button type="button" class="btn btn-dark btn-lg flex-grow-1 fw-bold py-3" onclick="checkLoginAndGo()">예약하기</button>

              <button class="btn btn-bookmark btn-lg px-3" onclick="this.classList.toggle('active')">
                <i class="bi bi-heart-fill"></i>
              </button>
            </div>

            <div class="pt-4 border-top">
              <h6 class="fw-bold mb-3 small"><i class="bi bi-compass me-1"></i> 주변 관광 명소 (2km 이내)</h6>
              <div id="tourMap" class="map-box" style="height: 180px;"></div>
            </div>
          </div>
        </div>
      </div>
    </aside>
    <!--    팝업 디자인 -->
    <div id="resvSuccessModal" class="resv-modal">
      <div class="resv-modal-content">
        <div class="modal-gold-line"></div>
        <div class="modal-body">
          <i class="bi bi-check2-circle mb-3 d-block" style="font-size: 40px; color: #C19A6B;"></i>
          <h4 class="fw-bold mb-2">RESERVATION CONFIRMED</h4>
          <p class="text-muted small mb-4">
            예약이 정상적으로 접수되었습니다.<br>
            정성스러운 요리로 맞이하겠습니다.
          </p>
          <button type="button" class="btn-modal-close" onclick="closeResvModal()">확인</button>
        </div>
      </div>
    </div>
    <!--    비로그인 팝업 디자인 -->
    <div id="loginCheckModal" class="resv-modal">
      <div class="resv-modal-content">
        <div class="modal-gold-line"></div>

        <div class="modal-body">
          <div class="modal-icon-wrapper">
            <i class="bi bi-shield-lock"></i>
          </div>

          <h5 class="modal-title">MEMBERSHIP ONLY</h5>
          <p class="modal-text">
            해당 서비스는 회원 전용 공간입니다.<br>
            <span>NEXT502</span>의 멤버가 되어 특별한 혜택을 누리세요.
          </p>

          <div class="modal-button-group">
            <button type="button" class="btn-cancel-minimal" onclick="closeLoginModal()">취소</button>
            <button type="button" class="btn-login-premium" onclick="location.href='/login'">로그인 하기</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</main>

<div th:replace="~{layout/footer :: footer}"></div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=<KAKAO_APP_KEY>&libraries=services"></script>
<script th:inline="javascript">
    window.onload = function() {
        // restaurant.lat/lng가 문자열이어도 숫자로 변환해서 안전하게 사용
        const latRaw = /*[[${restaurant.lat}]]*/ "35.1796";
        const lngRaw = /*[[${restaurant.lng}]]*/ "129.0756";
        const lat = parseFloat(latRaw) || 35.1796;
        const lng = parseFloat(lngRaw) || 129.0756;

        // 1. 메인 지도 설정
        const mapContainer = document.getElementById('map');
        const mapOption = { center: new kakao.maps.LatLng(lat, lng), level: 3 };
        const map = new kakao.maps.Map(mapContainer, mapOption);

        new kakao.maps.Marker({
            position: new kakao.maps.LatLng(lat, lng),
            map: map
        });

        // 2. 관광지 지도 설정
        const tourMapContainer = document.getElementById('tourMap');
        const tourMapOption = { center: new kakao.maps.LatLng(lat, lng), level: 5 };
        const tourMap = new kakao.maps.Map(tourMapContainer, tourMapOption);

        const ps = new kakao.maps.services.Places();
        ps.categorySearch('AT4', (data, status) => {
            if (status === kakao.maps.services.Status.OK) {
                data.forEach(place => {
                    new kakao.maps.Marker({
                        position: new kakao.maps.LatLng(place.y, place.x),
                        map: tourMap
                    });
                });
            }
        }, { location: new kakao.maps.LatLng(lat, lng), radius: 2000 });
    };

    // 비로그인 상황에서 예약하기 버튼눌렀을때 로그인 페이지로 보내주는 스크립트 0209 am  수정

    function checkLoginAndGo() {

      const resId = [[${restaurant.restaurantId}]];


      location.href = "/reservation/write?restaurantId=" + resId;
    }

    function closeLoginModal() {


      const modal = document.getElementById("loginCheckModal");
      if(modal) {
        modal.style.display = "none";
      }
    }


</script>
</body>
</html>
