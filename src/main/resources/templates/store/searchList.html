<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <div th:replace="~{layout/header :: header}"></div>
  <title>NEXT502 | 검색 결과</title>
  <style>
      :root { --main-gold: #b89255; }
      .text-gold { color: var(--main-gold) !important; }
      .btn-gold { background-color: var(--main-gold); color: white; border: none; }
      .btn-gold:hover { background-color: #9c7b46; color: white; }

      /* 사이드바 필터 */
      .filter-section { position: sticky; top: 100px; }
      .filter-title { font-size: 1rem; font-weight: bold; margin-bottom: 1rem; border-bottom: 2px solid var(--main-gold); padding-bottom: 5px; }
      .form-check-input:checked { background-color: var(--main-gold); border-color: var(--main-gold); }

      /* 식당 카드 */
      .res-card {
          border: none;
          border-bottom: 1px solid #eee;
          border-radius: 0;
          transition: background 0.2s;
          padding: 20px 0;
      }
      .res-card:hover { background-color: #fafafa; }
      .res-img-wrapper {
          width: 240px; height: 180px; overflow: hidden; border-radius: 8px;
          background: #f8f9fa; display: flex; align-items: center; justify-content: center;
      }
      .res-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }

      .badge-category { background-color: #f0f0f0; color: #666; font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; }
  </style>

</head>
<body class="bg-white">

<div th:replace="~{layout/navbar :: navbar}"></div>

<div class="bg-light py-3 border-bottom">
  <div class="container">
    <form action="/store/search" method="get" class="row g-2 justify-content-center">
      <div class="col-md-6">
        <div class="input-group">
          <input type="text" name="keyword" class="form-control border-0 shadow-sm" th:value="${keyword}" placeholder="지역, 식당 이름 검색...">
          <button class="btn btn-gold px-4" type="submit"><i class="bi bi-search"></i></button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="container my-5">
  <div class="row">
    <aside class="col-lg-3 pe-lg-5">
      <div class="filter-section">
        <div class="mb-5">
          <h6 class="filter-title">지역</h6>
          <div class="form-check mb-2" th:each="loc :
          ${ {'연제구' , '해운대구', '부산진구', '수영구','강서구','사상구','북구','사하구','서구','동구','중구','영도구','남구','동래구','금정구','기장군'} }">
            <input class="form-check-input" type="checkbox" th:value="${loc}" th:id="'loc-' + ${loc}"
                   th:checked="${selectedLocs != null and #lists.contains(selectedLocs, loc)}">
            <label class="form-check-label small" th:for="'loc-' + ${loc}" th:text="${loc}"></label>
          </div>
        </div>

        <div class="mb-5">
          <h6 class="filter-title">요리 유형</h6>
          <div class="form-check mb-2" th:each="cat : ${ {'중식' , '일식' , '한식' , '양식'} }">
            <input class="form-check-input" type="checkbox" th:value="${cat}" th:id="'cat-' + ${cat}"
                   th:checked="${selectedCats != null and #lists.contains(selectedCats, cat)}">
            <label class="form-check-label small" th:for="'cat-' + ${cat}" th:text="${cat}"></label>
          </div>
        </div>

        <button class="btn btn-outline-dark btn-sm w-100 mt-2">필터 초기화</button>
      </div>
    </aside>

    <main class="col-lg-9">
      <div class="d-flex justify-content-between align-items-end mb-4 pb-3 border-bottom">
        <div>
          <span class="fs-5 fw-bold text-dark">총 <span class="text-gold" th:text="${#lists.size(resList)}">0</span>곳의 미식 공간</span>
        </div>
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm border-0 bg-light" style="width: 120px;">
            <option value="rating" th:selected="${selectedSort == 'rating'}">별점순</option>
            <option value="reviews" th:selected="${selectedSort == 'reviews'}">리뷰순</option>
          </select>
        </div>
      </div>

      <div class="res-card card" th:each="res : ${resList}">
        <div class="row g-0 align-items-center">
          <div class="col-md-4">
            <div class="res-img-wrapper shadow-sm">
              <img src="" th:src="${res.mainImg}" class="card-img-top" alt="식당">
            </div>
          </div>
          <div class="col-md-8">
            <div class="card-body py-0 ps-md-4">
              <div class="mb-2">
                <span class="badge-category" th:text="${res.foods}"></span>
                <span class="ms-2 text-muted small"><i class="bi bi-geo-alt"></i> [[${res.locationTag}]]</span>
              </div>
              <h4 class="card-title fw-bold mb-2">
                <a th:href="@{/detail(id=${res.restaurantId})}"
                   class="text-decoration-none text-dark" th:text="${res.restaurantName}">식당명</a>
              </h4>
              <div class="mb-3">
                <span class="text-gold fw-bold fs-5">★ [[${res.rating}]]</span>
              </div>
              <p class="card-text text-secondary small mb-3 text-truncate" th:text="${res.description}">
                식당 소개글입니다.
              </p>
              <a th:href="@{/detail(id=${res.restaurantId})}" class="btn btn-dark btn-sm px-4">예약하기</a>
            </div>
          </div>
        </div>
      </div>

      <div th:if="${#lists.isEmpty(resList)}" class="py-5 text-center">
        <i class="bi bi-search fs-1 text-muted"></i>
        <p class="mt-3 text-secondary">검색 결과가 없습니다.</p>
      </div>
    </main>
  </div>
</div>

<div th:replace="~{layout/footer :: footer}"></div>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
    const filterInputs = document.querySelectorAll('.form-check-input, .form-select');
    const resetBtn = document.querySelector('.btn-outline-dark');
    const searchInput = document.querySelector('input[name="keyword"]');

    filterInputs.forEach(el => {
      el.addEventListener('change', () => {
        applyFilters();
      });
    });

    if (resetBtn) {
      resetBtn.addEventListener('click', () => {
        const keyword = searchInput.value;
        location.href = `/store/search?keyword=${encodeURIComponent(keyword)}`;
      });
    }

    function applyFilters() {
      const keyword = searchInput.value;

      const sort = document.querySelector('.form-select').value;

      const locations = Array.from(document.querySelectorAll('input[id^="loc-"]:checked'))
              .map(cb => cb.value);

      const categories = Array.from(document.querySelectorAll('input[id^="cat-"]:checked'))
              .map(cb => cb.value);

      const url = new URL(window.location.origin + '/store/search');
      url.searchParams.set('keyword', keyword);
      url.searchParams.set('sort', sort);

      if (locations.length > 0) {
        url.searchParams.set('locations', locations.join(','));
      }

      if (categories.length > 0) {
        url.searchParams.set('categories', categories.join(','));
      }

      location.href = url.toString();
    }
  });
</script>
</body>
</html>