<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <div th:replace="~{layout/header :: header}"></div>
  <title>관리자 대시보드 | NEXT502</title>
  <style>
      :root { --main-gold: #b89255; }
      .text-gold { color: var(--main-gold) !important; }
      .bg-gold { background-color: var(--main-gold) !important; color: white; }

      .list-group-item {
        text-decoration: none !important;
        border: none;
        border-bottom: 1px solid #eee;
      }

      .list-group-item.active {
        background-color: #f8f9fa !important;
        color: var(--main-gold) !important;
        border-left: 4px solid var(--main-gold) !important;
        border-top: none !important;
        border-right: none !important;
        border-bottom: 1px solid #eee !important;
        outline: none !important;
      }

      .list-group-item-action:focus,
      .list-group-item-action:active {
        z-index: 1;
        color: var(--main-gold) !important;
        text-decoration: none !important;
        background-color: #f8f9fa !important;
        box-shadow: none !important;
        outline: none !important;
        border-left: 4px solid var(--main-gold) !important;
      }

      /* 카드 */
      .summary-card { border: 1px solid #eee; border-radius: 8px; transition: 0.3s; }
      .summary-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
      .card-num { font-size: 1.8rem; font-weight: bold; color: var(--main-gold); }

      /* 테이블 */
      .table thead th { background-color: #f8f9fa; color: #666; font-weight: 600; border-top: none; }
      .status-completed { background-color: #fcfcfc; color: #bbb; }
  </style>

  <script>
    // DOM이 준비되면 바로 실행
    document.addEventListener('DOMContentLoaded', () => {
      const dateInput = document.getElementById('resvDateInput');
      if (dateInput) {
        dateInput.addEventListener('change', () => {
          const selectedDate = dateInput.value;
          if (selectedDate) {
            // 선택된 날짜로 GET 요청
            window.location.href = `/mngmenu?resvDate=${selectedDate}`;
          }
        });
      }

      document.querySelectorAll('.resv-row').forEach(row => {
        const statusCell = row.querySelector('.status-cell');
        const cancelBtn = statusCell.querySelector('.cancel-btn');

        // 취소 버튼 클릭
        if(cancelBtn){
          cancelBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // 행 클릭 이벤트 방지
            if(confirm('예약을 취소하시겠습니까?')){
              const resvId = row.getAttribute('data-resvid');
              fetch(`/mngmenu/cancel/${resvId}`, { method: 'DELETE' })
                      .then(res => {
                        if(res.ok){
                          row.remove(); // 테이블에서 제거
                        } else {
                          alert('취소 실패');
                        }
                      });
            }
          });
        }

        // 방문예정 행 클릭 시 버튼 생성
        row.addEventListener('click', () => {
          const currentStatus = row.getAttribute('data-status');

          if (currentStatus === '방문예정' && !statusCell.querySelector('.status-btn')) {
            statusCell.querySelector('.status-label').style.display = 'none';

            const visitBtn = document.createElement('button');
            visitBtn.textContent = '방문확인';
            visitBtn.className = 'btn btn-sm btn-outline-success status-btn mx-1';

            const noshowBtn = document.createElement('button');
            noshowBtn.textContent = '노쇼처리';
            noshowBtn.className = 'btn btn-sm btn-outline-warning noshow-btn mx-1';

            // 취소 버튼 뒤에 삽입
            statusCell.insertBefore(visitBtn, cancelBtn);
            statusCell.insertBefore(noshowBtn, cancelBtn);

            // 방문확인 클릭
            visitBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const resvId = row.getAttribute('data-resvid');
              fetch(`/mngmenu/confirm/${resvId}`, { method: 'PATCH' })
                      .then(res => {
                        if(res.ok){
                          statusCell.innerHTML = `<span class="badge bg-success">방문 완료</span>`;
                          row.setAttribute('data-status', '방문완료');
                        } else {
                          alert('상태 변경 실패');
                        }
                      });
            });

            // 노쇼 처리 클릭
            noshowBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const resvId = row.getAttribute('data-resvid');
              fetch(`/mngmenu/noshow/${resvId}`, { method: 'PATCH' })
                      .then(res => {
                        if(res.ok){
                          statusCell.innerHTML = `<span class="badge bg-danger">노쇼</span>`;
                          row.setAttribute('data-status', '노쇼');
                          row.classList.add('status-completed');
                        } else {
                          alert('노쇼 처리 실패');
                        }
                      });
            });
          }
        });
      });
    });
  </script>
</head>
<body class="bg-light">

<div th:replace="~{layout/navbar :: navbar}"></div>

<div class="container my-5">
  <div class="row g-4">
    <aside th:fragment="adminSidebar" class="col-lg-3">
      <div class="card shadow-sm border-0 mb-4 sticky-top" style="top: 20px;">
        <div class="card-header bg-dark text-white py-3 text-center">
          <h6 class="mb-0 fw-bold">ADMIN PANEL</h6>
        </div>
        <div class="list-group list-group-flush w-100">
          <a th:href="@{/mngmenu}"
             class="list-group-item list-group-item-action d-flex align-items-center py-3"
             th:classappend="${menuId == 'menu' ? 'active' : ''}">
            <i class="bi bi-calendar-check me-3"></i> 예약자 관리
          </a>
          <a th:href="@{/mngstoreWrite}"
             class="list-group-item list-group-item-action d-flex align-items-center py-3"
             th:classappend="${menuId == 'store' ? 'active' : ''}">
            <i class="bi bi-house-gear me-3"></i> 식당 정보 수정
          </a>
          <a th:href="@{/mngreview}"
             class="list-group-item list-group-item-action d-flex align-items-center py-3"
             th:classappend="${menuId == 'review' ? 'active' : ''}">
            <i class="bi bi-chat-dots me-3"></i> 리뷰 답변 관리
          </a>
        </div>
      </div>
    </aside>

    <main class="col-lg-9">
      <div class="card shadow-sm border-0 p-4">

        <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
          <h3 class="fw-bold mb-0">예약자 명단 관리</h3>
          <div class="d-flex align-items-center gap-2">
            <span class="small text-muted">조회 일자:</span>
            <input type="date" id="resvDateInput" class="form-control form-control-sm"
                   th:value="${resvDate ?: mng.resvDate}">
          </div>
        </div>

        <div class="row g-3 mb-5">
          <div class="col-md-4">
            <div class="summary-card bg-white p-4 text-center">
              <div class="card-num" th:text="${totalCount ?: 12}">12</div>
              <div class="small text-muted mt-1">오늘 총 예약</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="summary-card bg-white p-4 text-center">
              <div class="card-num" th:text="${visitCount ?: 8}">8</div>
              <div class="small text-muted mt-1 text-success">방문 완료</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="summary-card bg-white p-4 text-center">
              <div class="card-num" th:text="${waitingCount ?: 4}">4</div>
              <div class="small text-muted mt-1 text-warning">대기 중</div>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
            <tr>
              <th class="ps-3">시간</th>
              <th>예약자명</th>
              <th>인원</th>
              <th>연락처</th>
              <th class="text-center">상태 및 관리</th>
            </tr>
            </thead>
            <tbody th:each="mng : ${resvList}">
            <tr class="resv-row" th:data-resvid="${mng.resvId}" th:data-status="${mng.status}">
              <td class="ps-3 fw-bold" th:text="${mng.resvTime}">18:00</td>
              <td><a href="#" class="text-dark fw-bold" th:text="${mng.name + '님'}">김철수님</a></td>
              <td th:text="${mng.headCount}">2명</td>
              <td class="text-muted" th:text="${mng.phone}">010-1111-2222</td>
              <td class="text-center status-cell">
                <span th:switch="${mng.status}">
                  <span th:case="'방문예정'" class="btn btn-sm status-label bg-gold px-3">방문예정</span>
                  <span th:case="'방문완료'" class="badge bg-success bi bi-check2-all">방문 완료</span>
                  <span th:case="'노쇼'" class="badge bg-danger">노쇼</span>
                </span>
                <!-- 방문예정 상태일 때만 취소 버튼 -->
                <button class="btn btn-sm btn-outline-secondary cancel-btn" th:if="${mng.status == '방문예정'}">취소</button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<div th:replace="~{layout/footer :: footer}"></div>

</body>
</html>
